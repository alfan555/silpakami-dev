<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Pentest;
use Sentinel;
use Yajra\Datatables\Datatables;
use Carbon\Carbon;
use Symfony\Component\Console\Input\StringInput;

class adminPentestController extends Controller
{
    public function index()
    {

        return view('admin.pentest');
    }

    public function aprove (Request $request){
        $id = $request->idaprove;
        list($date1, $date2) = explode(' - ', $request->tgl);
        Pentest::where('id', $id)->update([
            'stat'=>"2",
            'tgl_kick_off'=>$date1,
            'tgl_end_date'=>$date2
        ]);
        try{
            return redirect()
            ->back()
            ->withSuccess(sprintf('Pengajuan Layanan Telah Disetujui'));
        }
        catch(QueryException $e){
            return redirect()->back()->with(['error' => "Gagal."]);
        }
    }

    public function getData()
    {
        $skpdid = Sentinel::getUser()->instansi_id;
        $users = Pentest::join('users', 'users.id', '=', 'pentests.user_id')
        ->join('instansis', 'users.instansi_id', '=', 'instansis.id')    
        ->select([
                'pentests.id',
                'nama_aplikasi',
                'tipe_aplikasi',
                'deskripsi',
                'url',
                'path',
                'penanggung_jawab',
                'no_kontak',
                'stat',
                'pentests.created_at',
                'users.nama',
                'instansis.nama_ins',
                'users.email',
                'tgl_kick_off',
                'tgl_end_date'
            ])
            ->where('instansi_id', $skpdid)
            ->orderBy('created_at', 'DESC');

        return Datatables::of($users)
            ->addColumn('action', function ($user) {
                if ($user->stat == '1') {
                    return '<a href="" data-bs-toggle="modal" data-bs-target="#detail" id="bdetail" class="btn btn-outline-info"
                    data-id="' . $user->id . '"
                    data-nama="' . $user->nama . '"
                    data-instansi="' . $user->nama_ins . '"
                    data-path="'.$user->path.'"
                    data-nama_aplikasi="' . $user->nama_aplikasi . '"
                    data-tipe_aplikasi="' . $user->tipe_aplikasi . '"
                    data-url="' . $user->url . '"
                    data-deskripsi="' . $user->deskripsi . '"
                    data-penanggung_jawab="' . $user->penanggung_jawab . '"
                    data-no_kontak="' . $user->no_kontak . '"
                    data-email="' . $user->email . '">Detail</a>
                    <a href="" data-bs-toggle="modal" data-bs-target="#aproved" id="baproved" class="btn btn-outline-danger" data-id="' . $user->id . '" data-email="' . $user->email . '">Aprove</a>';
                } else {
                    return '<a href="" data-bs-toggle="modal" data-bs-target="#detail" id="bdetail" class="btn btn-outline-info"
                    data-id="' . $user->id . '"
                    data-nama="' . $user->nama . '"
                    data-instansi="' . $user->nama_ins . '"
                    data-path="'.$user->path.'"
                    data-nama_aplikasi="' . $user->nama_aplikasi . '"
                    data-tipe_aplikasi="' . $user->tipe_aplikasi . '"
                    data-url="' . $user->url . '"
                    data-deskripsi="' . $user->deskripsi . '"
                    data-penanggung_jawab="' . $user->penanggung_jawab . '"
                    data-no_kontak="' . $user->no_kontak . '"
                    data-email="' . $user->email . '">Detail</a>';
                }
            })
            ->addColumn('estimasi', function ($user) {
                if ($user->stat == '2') {
                    return $user->tgl_kick_off .' s/d ' .$user->tgl_end_date;
                } elseif ($user->stat == '5') {
                    return 'Selesai';
                } else {
                    return 'Belum Tersedia';
                }
            })
            ->editColumn('status', function ($stat) {
                if ($stat->stat == '1') {
                    return '<span class="badge bg-primary">Baru</span>';
                } elseif ($stat->stat == '2') {
                    return '<span class="badge bg-success">Diproses</span>';
                } elseif ($stat->stat == '3') {
                    return '<span class="badge bg-warning">Dibatalkan</span>';
                } elseif ($stat->stat == '4') {
                    return '<span class="badge bg-danger">Ditolak</span>';
                } elseif ($stat->stat == '5') {
                    return '<span class="badge bg-info">Selesai</span>';
                }
            })
            ->rawColumns(['id', 'status', 'action'])
            ->addIndexColumn()
            ->make(true);
    }

}
